package gui;

import java.awt.Color;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.Date;
import java.util.concurrent.TimeUnit;

import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.Timer;;

class TimerJLabel extends JLabel{

	private Timer t;
	private Date lastResumeTime;
	private long elapsedTimeInLastResume = 0;
	private boolean isBlink = false;

	TimerJLabel() {

		this.setHorizontalAlignment(CENTER);
		this.setIcon(new ImageIcon(MainView.class.getResource("/resources/k-timer-icon.png")));
		this.setFont(new Font(getFont().getName(), Font.PLAIN, 20));

		t = new Timer(1000, new clockListener());
		t.setInitialDelay(0);
		start();
	}

	void start() {
		resume();
		t.start();
	}

	void pause() {
		lastResumeTime = calcElapsedMilli(); // freeze elapsed time counting
		isBlink = true;		
	}
	
	void resume() {
		lastResumeTime = new Date().getTime();
		isBlink = false;
	}
	
	private String getElapsedTime() {
		long elapsedMilli = calcElapsedMilli();
		long hr = TimeUnit.MILLISECONDS.toHours(elapsedMilli);
		long min = TimeUnit.MILLISECONDS.toMinutes(elapsedMilli - TimeUnit.HOURS.toMillis(hr));
		long sec = TimeUnit.MILLISECONDS.toSeconds(elapsedMilli - TimeUnit.HOURS.toMillis(hr) - TimeUnit.MINUTES.toMillis(min));
		return String.format("%02d:%02d:%02d", hr,min,sec);				
	}

	private long calcElapsedMilli() {
		return ((new Date().getTime()) - lastResumeTime) + elapsedTimeInLastResume;
	}
	
	private class clockListener implements ActionListener {
		private boolean isForeground = false;
		private Color bg = TimerJLabel.this.getBackground();
		private Color fg = TimerJLabel.this.getForeground();
		@Override
		public void actionPerformed(ActionEvent e) {
			if (!isBlink) { //regular mode
				if (isForeground) { // return to show label if needed
					TimerJLabel.this.setForeground(fg);
					isForeground = false;
				}
				TimerJLabel.this.setText(getElapsedTime());
			}
			else { // blinking
				if (!isForeground) { // text color is different color than background color
					TimerJLabel.this.setForeground(bg);
					isForeground = true;
				}
				else { //text is in background color, unseen
					TimerJLabel.this.setForeground(fg);
					isForeground = false;
				}
			}
		}

	}
}
